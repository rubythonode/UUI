global.CONNS=CONNS=OBJECT({init:function(t,e,o){"use strict";var a,r=t.socketPack,i={};o.addRoomFunc=a=function(t,e){void 0===i[t]&&(i[t]=[]),i[t].push(e)},r.on("connection",function(t){var e,o=t.handshake.headers["x-forwarded-for"],a={},r={},n={},d={};void 0===o&&(o=t.handshake.address.address),t.addListener("disconnect",function(){EACH(d,function(t){EACH(t,function(t){t()})})}),t.addListener("__ENTER_ROOM",function(c){EACH(i,function(i,v){var s,u="",f=v,E={};return s=function(t){var e,o;return-1!==f.indexOf("{")&&-1!==f.indexOf("}")&&(o=f.substring(0,f.indexOf("{")),u+"/"===o)?(e=f.substring(f.indexOf("{")+1,f.indexOf("}")),f=o+t+f.substring(f.indexOf("}")+1),{name:e,value:t}):void 0},EACH(c.split("/"),function(t,e){var o=s(t);return void 0!==o&&(E[o.name]=o.value),0===e?u=t:u+="/"+t,u===f?!1:void 0}),c===f?(void 0===r[c]?(a[c]=[],d[c]=[],t.join(c),EACH(i,function(r){a[c].push(r(c,t,o,t.handshake.headers,E,function(t){e=t},function(){return e},function(){e=void 0},n,d[c]))}),r[c]=1):r[c]+=1,!1):void 0})}),t.addListener("__EXIT_ROOM",function(e){r[e]-=1,0===r[e]&&(EACH(a[e],function(t){t.removeAllListeners()}),t.leave(e),delete a[e],delete r[e],delete d[e])})})}}),FOR_BOX(function(t){"use strict";t.DB=CLASS({init:function(e,o,a,r){var i,n,d,c,v,s,u,f,E,m,D,h,R,S,O,A,C,l=UPPERCASE.IO.MODULE("mongolian").ObjectId;SERVER_CONFIG.isNotUsingDB===!0?(a.createData=m=function(){},a.getData=D=function(){},a.updateData=h=function(){},a.removeData=R=function(){},a.findData=S=function(){},a.findDataSet=O=function(){},a.countDataSet=A=function(){},a.checkIsExists=C=function(){}):(i=UPPERCASE.IO.db.collection(t.boxName+"."+r),n=UPPERCASE.IO.db.collection(t.boxName+"."+r+"__BACKUP"),d=UPPERCASE.IO.db.collection(t.boxName+"."+r+"__ERROR"),c=function(t){return new l(t)},v=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__IS_ENABLED,t},s=function(t){EACH(t,function(e,o){e===TO_DELETE?REMOVE_AT({data:t,key:o}):(CHECK_IS_DATA(e)===!0||CHECK_IS_ARRAY(e)===!0)&&s(e)})},u=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(e,o){CHECK_IS_DATA(e)===!0||CHECK_IS_ARRAY(e)===!0?EACH(e,function(t,o){e[o]=c(t)}):t.id[o]=c(e)}),t._id=t.id):t._id=c(id),delete t.id),t.__IS_ENABLED=!0,EACH(t,function(e,o){void 0===e&&delete t[o]})},f=function(t){var e=t.method,o=t.data,a=new Date,r={method:e,time:a,data:o};n.save(r),SERVER_CONFIG.isDBLogMode===!0&&console.log("[DB SAVED]",r)},E=function(t){t.time=new Date,d.save(t),SERVER_CONFIG.isDBLogMode===!0&&console.log("[DB ERROR]",t)},a.createData=m=function(t,e){var o;try{t.__IS_ENABLED=!0,t.createTime=new Date,s(t),i.save(t,function(a,r){null===a?(f({method:"createData",data:r}),v(r),void 0!==e&&e(void 0,r)):(o=a.toString(),E({method:"createData",data:t,errorMsg:o}),void 0!==e&&e(o))})}catch(a){o=a.toString(),E({method:"createData",data:t,errorMsg:o}),void 0!==e&&e(o)}},a.getData=D=function(t,e){var o,a;try{o={_id:c(t),__IS_ENABLED:!0},i.findOne(o,function(o,r){null===o?(void 0!==r&&v(r),e(void 0,r)):(a=o.toString(),E({method:"getData",id:t,errorMsg:a}),e(a))})}catch(r){a=r.toString(),E({method:"getData",id:t,errorMsg:a}),e(a)}},a.updateData=h=function(t,e){var o,a,r=t.id;try{o={_id:c(r),__IS_ENABLED:!0},i.findOne(o,function(o,r){delete t.id,null===o?void 0===r?void 0!==e&&e():(EACH(r,function(e,o){(void 0===t[o]||"_id"===o||"__IS_ENABLED"===o||"createTime"===o)&&(t[o]=e)}),s(t),t.lastUpdateTime=new Date,i.save(t,function(o,r){null===o?(f({method:"updateData",data:r}),v(r),void 0!==e&&e(void 0,r)):(a=o.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==e&&e(a))})):(a=o.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==e&&e(a))})}catch(n){a=n.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==e&&e(a)}},a.removeData=R=function(t,e){var o,a;try{o={_id:c(t),__IS_ENABLED:!0},i.findOne(o,function(o,r){null===o?void 0===r?void 0!==e&&e():(r.__IS_ENABLED=!1,r.removeTime=new Date,i.save(r,function(o,r){null===o?(f({method:"removeData",data:r}),v(r),void 0!==e&&e(void 0,r)):(a=o.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==e&&e(a))})):(a=o.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==e&&e(a))})}catch(r){a=r.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==e&&e(a)}},a.findData=S=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{u(t),i.findOne(t,function(a,r){null===a?(void 0!==r&&v(r),e(void 0,r)):(o=a.toString(),E({method:"findData",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"findData",filter:t,errorMsg:o}),e(o)}},a.findDataSet=O=function(t,e){var o,a,r=void 0===t?void 0:t.filter,n=void 0===t?void 0:t.sort,d=void 0===t?void 0:t.start,c=void 0===t||void 0===t.count?void 0:INTEGER(t.count),s=void 0===t||void 0===t.isFindAll?void 0:INTEGER(t.isFindAll);void 0!==t&&void 0===e&&(e=t);try{void 0===r&&(r={}),void 0===n&&(n={}),void 0===d&&(d=0),s!==!0&&(void 0===c||c>SERVER_CONFIG.maxDataCount||isNaN(c)===!0?c=SERVER_CONFIG.maxDataCount:1>c&&(c=1)),u(r),a=function(a,r){null===a?(void 0!==r&&EACH(r,function(t){v(t)}),e(void 0,r)):(o=a.toString(),E({method:"findDataSet",params:t,errorMsg:o}),e(o))},s===!0?i.find(r).sort(n).skip(d).toArray(a):i.find(r).sort(n).skip(d).limit(c).toArray(a)}catch(f){o=f.toString(),E({method:"findDataSet",params:t,errorMsg:o}),e(o)}},a.countDataSet=A=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{u(t),i.find(t).count(function(a,r){null===a?e(void 0,r):(o=a.toString(),E({method:"countDataSet",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"countDataSet",filter:t,errorMsg:o}),e(o)}},a.checkIsExists=C=function(t,e){var o;void 0!==t&&void 0===e&&(e=t),void 0===t&&(t={});try{u(t),i.find(t).count(function(a,r){null===a?e(void 0,void 0!==r&&r>0):(o=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:o}),e(o))})}catch(a){o=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:o}),e(o)}})}})}),FOR_BOX(function(t){"use strict";t.LOG_DB=CLASS({init:function(e,o,a,r){var i,n;SERVER_CONFIG.isNotUsingDB===!0?a.log=n=function(){}:(i=UPPERCASE.IO.db.collection(t.boxName+"."+r),a.log=n=function(t){t.time=new Date,i.save(t)})}})}),FOR_BOX(function(t){"use strict";OVERRIDE(t.MODEL,function(){t.MODEL=CLASS({init:function(e,o,a,r){var i,n,d,c,v,s,u,f,E,m,D,h,R,S,O,A,C,l,_,g,N,M,p=r.name,b=void 0===r.propertyNamesForNewEvent?[]:r.propertyNamesForNewEvent,I=r.config,H=t.DB(p);void 0!==I&&(i=I.create,n=I.getData,d=I.update,c=I.remove,v=I.findData,s=I.findDataSet,u=I.countDataSet,f=I.checkIsExists,void 0!==i&&(E=i.valid),void 0!==d&&(m=d.valid)),o.getCreateValid=D=function(){return E},o.getUpdateValid=h=function(){return m},t.ROOM(p+"/create"),EACH(b,function(e){t.ROOM(p+"/"+e+"/{value}/create")}),t.ROOM(p+"/remove"),EACH(b,function(e){t.ROOM(p+"/"+e+"/{value}/remove")}),t.ROOM(p,function(e){i!==!1&&e.on("create",function(a,r){var i,n=void 0===E?void 0:E.check({data:a});void 0!==n&&n.checkHasError()===!0?r({hasError:!0,errors:n.getErrors()}):(i=function(){H.createData(a,function(a,i){void 0!==a?r({hasError:!0,errorMsg:a}):(void 0!==o.afterCreate&&o.afterCreate(i),void 0!==o.afterCreateRoom&&o.afterCreateRoom({savedData:i,room:e}),t.ROOMS(p+"/create").broadcast({methodName:"create",data:i}),EACH(b,function(e){var o=i[e];t.ROOMS(p+"/"+e+"/"+o+"/create").broadcast({methodName:"create",data:i})}),r({hasError:!1,savedData:i}))})},void 0===o.beforeCreateRoom?void 0!==o.beforeCreate?o.beforeCreate(a,{ret:r,proc:i})!==!1&&i():i():o.beforeCreateRoom({data:a,room:e},{ret:r,proc:i}))}),n!==!1&&e.on("getData",O),v!==!1&&e.on("findData",l),s!==!1&&e.on("findDataSet",function(t,e){delete t.isFindAll,_(t,e)}),u!==!1&&e.on("countDataSet",g),f!==!1&&e.on("checkIsExists",N)}),t.ROOM(p+"/{id}",function(e,a){var r=a.id;d!==!1&&e.on("update",function(t,a){var i,n=void 0===m?void 0:m.check({data:t,isExceptUndefined:!0});t.id=r,void 0!==n&&n.checkHasError()===!0?a({hasError:!0,errors:n.getErrors()}):(i=function(){H.updateData(t,function(t,r){void 0!==t?a({hasError:!0,errorMsg:t}):(void 0!==r&&(void 0!==o.afterUpdate&&o.afterUpdate(r),void 0!==o.afterUpdateRoom&&o.afterUpdateRoom({savedData:r,room:e}),e.broadcast({methodName:"update",data:r})),a({hasError:!1,savedData:r}))})},void 0===o.beforeUpdateRoom?void 0!==o.beforeUpdate?o.beforeUpdate(t,{ret:a,proc:i})!==!1&&i():i():o.beforeUpdateRoom({data:t,room:e},{ret:a,proc:i})!==!1&&i())}),c!==!1&&e.on("remove",function(a,r){var i;i=function(){H.removeData(a,function(a,i){void 0!==a?r({hasError:!0,errorMsg:a}):(void 0!==i&&(void 0!==o.afterRemove&&o.afterRemove(i),void 0!==o.afterRemoveRoom&&o.afterRemoveRoom({savedData:i,room:e}),e.broadcast({methodName:"remove",data:i}),EACH(b,function(e){var o=i[e];t.ROOMS(p+"/"+e+"/"+o+"/remove").broadcast({methodName:"remove",data:i})})),r({hasError:!1,savedData:i}))})},void 0===o.beforeRemoveRoom?void 0!==o.beforeRemove?o.beforeRemove(a,{ret:r,proc:i})!==!1&&i():i():o.beforeRemoveRoom({id:a,room:e},{ret:r,proc:i})!==!1&&i()})}),o.getDB=R=function(){return H},i!==!1&&(a.create=S=function(e,a){var r,i=void 0===E?void 0:E.check({data:e});void 0!==i&&i.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:i.getErrors()}):(r=function(){H.createData(e,function(e,r){void 0!==e?void 0!==a&&a({hasError:!0,errorMsg:e}):(void 0!==o.afterCreate&&o.afterCreate(r),t.ROOMS(p+"/create").broadcast({methodName:"create",data:r}),EACH(b,function(e){var o=r[e];t.ROOMS(p+"/"+e+"/"+o+"/create").broadcast({methodName:"create",data:r})}),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==o.beforeCreate?o.beforeCreate(e,{ret:a,proc:r})!==!1&&r():r())}),n!==!1&&(a.getData=O=function(t,e){H.getData(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.getData||o.getData(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedData:a})})}),d!==!1&&(a.update=A=function(e,a){var r,i=void 0===m?void 0:m.check({data:e,isExceptUndefined:!0});void 0!==i&&i.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:i.getErrors()}):(r=function(){H.updateData(e,function(r,i){void 0!==r?void 0!==a&&a({hasError:!0,errorMsg:r}):(void 0!==i&&(void 0!==o.afterUpdate&&o.afterUpdate(i),t.ROOMS(p+"/"+e.id).broadcast({methodName:"update",data:i})),void 0!==a&&a({hasError:!1,savedData:i}))})},void 0!==o.beforeUpdate?o.beforeUpdate(e,{ret:a,proc:r})!==!1&&r():r())}),c!==!1&&(a.remove=C=function(e,a){var r;r=function(){H.removeData(e,function(e,r){void 0!==e?void 0!==a&&a({hasError:!0,errorMsg:e}):(void 0!==r&&(void 0!==o.afterRemove&&o.afterRemove(r),t.ROOMS(p+"/"+r.id).broadcast({methodName:"remove",data:r}),EACH(b,function(e){var o=r[e];t.ROOMS(p+"/"+e+"/"+o+"/remove").broadcast({methodName:"remove",data:r})})),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==o.beforeRemove?o.beforeRemove(e,{ret:a,proc:r})!==!1&&r():r()}),v!==!1&&(a.findData=l=function(t,e){H.findData(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.findData||o.findData(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedData:a})})}),s!==!1&&(a.findDataSet=_=function(t,e){H.findDataSet(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.findDataSet||o.findDataSet(a,e)!==!1)&&void 0!==e&&e({hasError:!1,savedDataSet:a})})}),u!==!1&&(a.countDataSet=g=function(t,e){H.countDataSet(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.countDataSet||o.countDataSet(a,e)!==!1)&&void 0!==e&&e({hasError:!1,count:a})})}),f!==!1&&(a.checkIsExists=N=function(t,e){H.checkIsExists(t,function(t,a){void 0!==t?void 0!==e&&e({hasError:!0,errorMsg:t}):(void 0===o.checkIsExists||o.checkIsExists(a,e)!==!1)&&void 0!==e&&e({hasError:!1,isExists:a})})}),o.getName=M=function(){return p}}})})}),FOR_BOX(function(t){"use strict";t.MODULE=METHOD({run:function(e,o){var a=__dirname+"/../..";return require(a+"/"+t.boxName+"/SERVER/node_modules/"+o)}})}),FOR_BOX(function(t){"use strict";t.ROOM=METHOD({run:function(e,o,a){CONNS.addRoomFunc(t.boxName+"/"+o,function(t,e,o,r,i,n,d,c,v,s){var u=OBJECT({init:function(a,i,u){var f,E,m,D,h,R,S,O,A,C,l,_,g,N,M={};u.on=f=function(o,a){var r,i=t+"/"+o;r=function(t){var o=CHECK_IS_DATA(t.data)===!0?UNPACK_DATA(t.data):t.data,r=t.instantListenerName;a(o,function(t){e.emit(r,CHECK_IS_DATA(t)===!0?PACK_DATA(t):t)})},e.addListener(i,r),void 0===M[i]&&(M[i]=[]),M[i].push(r)},u.broadcast=E=function(e){var o=e.methodName,a=CHECK_IS_DATA(e.data)===!0?PACK_DATA(e.data):e.data,r=t+"/"+o;CONNS.type.socketPack["in"](t).emit(r,a)},u.broadcastExceptSender=m=function(o){var a=o.methodName,r=CHECK_IS_DATA(o.data)===!0?PACK_DATA(o.data):o.data,i=t+"/"+a;e.broadcast.to(t).emit(i,r)},u.removeAllListeners=D=function(){EACH(M,function(t,o){EACH(t,function(t){e.removeListener(o,t)})}),M.length=0},u.setAuthKey=h=function(t){n(t)},u.getAuthKey=R=function(){return d()},u.removeAuthKey=S=function(){c()},u.addRole=O=function(t){v[t]=!0},u.checkRole=A=function(t){return v[t]===!0},u.removeRole=C=function(t){REMOVE_AT({data:v,key:t})},u.removeAllRoles=l=function(){EACH(v,function(t,e){REMOVE_AT({data:v,key:e})})},u.addDisconnectListener=_=function(t){s.push(t)},u.getIp=g=function(){return o},u.getHeaders=N=function(){return r}}});return void 0!==a&&a(u,i),u})}})}),FOR_BOX(function(t){"use strict";t.ROOMS=CLASS({init:function(e,o,a,r){var i,n=t.boxName+"/"+r;a.broadcast=i=function(t){var e=t.methodName,o=CHECK_IS_DATA(t.data)===!0?PACK_DATA(t.data):t.data,a=n+"/"+e;CONNS.type.socketPack["in"](n).emit(a,o)}}})}),global.SERVER_CONFIG=SERVER_CONFIG={dbName:"UPPERCASE.IO-testdb",dbUsername:"test",dbPassword:"test",isNotRequiringDBAuth:!1,maxDataCount:1e3,securedUsername:"test",securedPassword:"test",authedPageUrl:"/UPPERCASE.IO/R/AUTHED.html",errorPageUrl:"/UPPERCASE.IO/R/ERROR.html"},global.SHA1=SHA1=METHOD({run:function(t,e){"use strict";var o=e.key,a=e.password,r=require("crypto");return r.createHmac("sha1",o).update(a).digest("hex")}}),global.TIME_SYNC=TIME_SYNC=OBJECT({init:function(){"use strict";UPPERCASE.IO.ROOM("timeSync",function(t){t.on("sync",function(t,e){var o=new Date,a=t.now;e({diff:a-o})})})}});